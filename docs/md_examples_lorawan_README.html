<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AllWize Library: AllWize to LoRaWAN - Proof of Concept</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AllWize Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="classAllWize.html">AllWize</a> to LoRaWAN - Proof of Concept </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p class="">These two example codes are a PoC to send messages from a Wize node to The Things Network (or any other LoRaWAN server).</p>
<h2>Implementation</h2>
<p class="">The PoC is based on two protocol implementations.</p>
<ul>
<li>LoRaWAN frame support for nodes</li>
<li>Semtech legacy packet forwarder running on an ESP8266 acting as gateway</li>
</ul>
<p class="">First the Wize payload in the node (sender) is encoded as a LoRaWAN compatible frame. This means that the total payload size is bigger than with just LoRaWAN, since its wrapped with Wize headers and checksum. The encription is done in the sender, just like with a regular LoRaWan node, using both the network and the application session keys. Only Activation-by-Personalisation (ABP) is supported.</p>
<p class="">The Wize message is received by a Wize single-channel gateway. The gateway does not decrypt the message and acts as a dumb bridge building an UDP frame compatible with the Semtech legacy packet forwarder protocol. It presents itself as an FSK gateway, providing useful information in the channel, datarate and RSSI fields.</p>
<p class="">Current limitations due to implementation details are:</p>
<ul>
<li>Only uplink support</li>
<li>Only ABP support</li>
<li>Payload size is big (i.e. more time on air)</li>
</ul>
<h2>Usage</h2>
<h3>Node (Sender)</h3>
<p class="">To encode the message as a LoRaWAN compatible frame you just have to use the <a class="el" href="classAllWize__LoRaWAN.html">AllWize_LoRaWAN</a> class instead of the <a class="el" href="classAllWize.html">AllWize</a> class and provide proper activation keys. The <a class="el" href="classAllWize__LoRaWAN.html">AllWize_LoRaWAN</a> class wraps up the <a class="el" href="classAllWize.html">AllWize</a> class providing LoRaWAN frame encoding and AES encryption. The it relies on the underneath <a class="el" href="classAllWize.html">AllWize</a> class to send the LoRaWAN message inside a Wize frame.</p>
<p class="">Here you have a fragment of the sample code:</p>
<div class="fragment"><div class="line">#include &quot;AllWize_LoRaWAN.h&quot;</div><div class="line">AllWize_LoRaWAN allwize(RX_PIN, TX_PIN, RESET_PIN);</div><div class="line"></div><div class="line">void wizeSetup() {</div><div class="line"></div><div class="line">    // Init communication to the module</div><div class="line">    allwize-&gt;begin();</div><div class="line">    if (!allwize-&gt;waitForReady()) {</div><div class="line">        Serial.println(&quot;[WIZE] Error connecting to the module, check your wiring!&quot;);</div><div class="line">        while (true);</div><div class="line">    }</div><div class="line"></div><div class="line">    // Wize settings</div><div class="line">    allwize-&gt;slave();</div><div class="line">    allwize-&gt;setChannel(WIZE_CHANNEL, true);</div><div class="line">    allwize-&gt;setPower(WIZE_POWER);</div><div class="line">    allwize-&gt;setDataRate(WIZE_DATARATE);</div><div class="line"></div><div class="line">    // LoRaWan settings</div><div class="line">    allwize-&gt;joinABP(DEVADDR, APPSKEY, NWKSKEY);</div><div class="line"></div><div class="line">}</div></div><!-- fragment --><h3>Gateway</h3>
<p class="">The gateway code is meant to be run on an ESP8266 board with Wize module. This is the standard setup for our <a class="el" href="classAllWize.html">AllWize</a> G1 gateways (a Wemos D1 with an <a class="el" href="classAllWize.html">AllWize</a> K1 shield).</p>
<p class="">The gateway code is split into different "modules" (components) so it's easier to manage and understand. These modules are responsible for different actions:</p>
<ul>
<li><b>main</b>: main entry point, initializes the different components and manages the polling</li>
<li><b>debug</b>: serial debug definitions</li>
<li><b>wifi</b>: handles WiFi connectivity</li>
<li><b>ntp</b>: keeps local RTC in time using NTP</li>
<li><b>wize</b>: handles incomming Wize messages</li>
<li><b>lorawan</b>: keeps gateway "alive" by pinging the server every 30s, encodes and sends messages inside UDP frames to the server</li>
</ul>
<p class="">To configure the different modules, first copy the <code>configuration.sample.h</code> file to <code>configuration.h</code> and edit it providing proper information. At least you should provide the WiFi connection credentials and the Gateway configuration (location, type, description and admin email).</p>
<p class="">You will need two thrid party libraries (both available in the Arduino Library Manager):</p>
<ul>
<li><b>EspSoftwareSerial</b> by  (<a href="https://github.com/plerup/espsoftwareserial">https://github.com/plerup/espsoftwareserial</a>)</li>
<li><b>NtpClientLib</b> by  (<a href="https://github.com/gmag11/NtpClient">https://github.com/gmag11/NtpClient</a>)</li>
</ul>
<h2>License</h2>
<p class="">Copyright (C) 2018-2019 by <a class="el" href="classAllWize.html">AllWize</a> (<a href="http://allwize.io">http://allwize.io</a>)</p>
<p class=""><a class="el" href="classAllWize.html">AllWize</a> library is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p>
<p class=""><a class="el" href="classAllWize.html">AllWize</a> library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.</p>
<p class="">You should have received a copy of the GNU Lesser General Public License along with <a class="el" href="classAllWize.html">AllWize</a> library. If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
