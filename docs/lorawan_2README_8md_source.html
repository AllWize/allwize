<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AllWize Library: examples/lorawan/README.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AllWize Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">examples/lorawan/README.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="lorawan_2README_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# AllWize to LoRaWAN - Proof of Concept</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;These two example codes are a PoC to send messages from a Wize node to The Things Network (or any other LoRaWAN server). </div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;## Implementation</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;The PoC is based on two protocol implementations. </div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;* LoRaWAN frame support for nodes</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;* Semtech legacy packet forwarder running on an ESP8266 acting as gateway</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;First the Wize payload in the node (sender) is encoded as a LoRaWAN compatible frame. This means that the total payload size is bigger than with just LoRaWAN, since its wrapped with Wize headers and checksum. The encription is done in the sender, just like with a regular LoRaWan node, using both the network and the application session keys. Only Activation-by-Personalisation (ABP) is supported.</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;The Wize message is received by a Wize single-channel gateway. The gateway does not decrypt the message and acts as a dumb bridge building an UDP frame compatible with the Semtech legacy packet forwarder protocol. It presents itself as an FSK gateway, providing useful information in the channel, datarate and RSSI fields.</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;Current limitations due to implementation details are:</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;* Only uplink support</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;* Only ABP support</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;* Payload size is big (i.e. more time on air)</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;## Usage</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;### Node (Sender)</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;To encode the message as a LoRaWAN compatible frame you just have to use the AllWize_LoRaWAN class instead of the AllWize class and provide proper activation keys. The AllWize_LoRaWAN class wraps up the AllWize class providing LoRaWAN frame encoding and AES encryption. The it relies on the underneath AllWize class to send the LoRaWAN message inside a Wize frame.</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;Here you have a fragment of the sample code:</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;```</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;#include &quot;AllWize_LoRaWAN.h&quot;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;AllWize_LoRaWAN allwize(RX_PIN, TX_PIN, RESET_PIN);</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;void wizeSetup() {</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    // Init communication to the module</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    allwize.begin();</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    if (!allwize.waitForReady()) {</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;        Serial.println(&quot;[WIZE] Error connecting to the module, check your wiring!&quot;);</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;        while (true);</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    }</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    // Wize settings</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    allwize.slave();</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    allwize.setChannel(WIZE_CHANNEL, true);</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    allwize.setPower(WIZE_POWER);</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    allwize.setDataRate(WIZE_DATARATE);</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    // LoRaWan settings</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    allwize.joinABP(DEVADDR, APPSKEY, NWKSKEY);</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;}</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;```</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;### Gateway</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;The gateway code is meant to be run on an ESP8266 board with Wize module. This is the standard setup for our AllWize G1 gateways (a Wemos D1 with an AllWize K1 shield).</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;The gateway code is split into different &quot;modules&quot; (components) so it&#39;s easier to manage and understand. These modules are responsible for different actions:</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;* **main**: main entry point, initializes the different components and manages the polling</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;* **debug**: serial debug definitions</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;* **wifi**: handles WiFi connectivity</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;* **ntp**: keeps local RTC in time using NTP</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;* **wize**: handles incomming Wize messages</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;* **lorawan**: keeps gateway &quot;alive&quot; by pinging the server every 30s, encodes and sends messages inside UDP frames to the server</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;To configure the different modules, first copy the `configuration.sample.h` file to `configuration.h` and edit it providing proper information. At least you should provide the WiFi connection credentials and the Gateway configuration (location, type, description and admin email).</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;You will need two thrid party libraries (both available in the Arduino Library Manager):</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;* **EspSoftwareSerial** by @plerup (https://github.com/plerup/espsoftwareserial)</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;* **NtpClientLib** by @gmag11 (https://github.com/gmag11/NtpClient)</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;## License</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;Copyright (C) 2018-2019 by AllWize ([http://allwize.io](http://allwize.io))</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;AllWize library is free software: you can redistribute it and/or modify</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;it under the terms of the GNU Lesser General Public License as published by</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;the Free Software Foundation, either version 3 of the License, or</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;(at your option) any later version.</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;AllWize library is distributed in the hope that it will be useful,</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;but WITHOUT ANY WARRANTY; without even the implied warranty of</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;GNU Lesser General Public License for more details.</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;You should have received a copy of the GNU Lesser General Public License</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;along with AllWize library.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</div></div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
